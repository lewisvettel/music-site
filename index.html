<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>清澈电台</title>
  <!-- 引入Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- 引入Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  
  <!-- Tailwind配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f8fafc',
            secondary: '#e0f2fe',
            accent: '#bae6fd',
            glow: '#7dd3fc',
            glow2: '#c084fc',
            glow3: '#93c5fd',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          animation: {
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 6s ease-in-out infinite',
            'float-delay': 'float 6.5s ease-in-out infinite 0.5s',
            'glow': 'glow 2s ease-in-out infinite alternate',
            'glow-multi': 'glow-multi 4s ease-in-out infinite alternate',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 5px rgba(125, 211, 252, 0.5), 0 0 10px rgba(125, 211, 252, 0.3)' },
              '100%': { boxShadow: '0 0 15px rgba(125, 211, 252, 0.8), 0 0 30px rgba(125, 211, 252, 0.5)' },
            },
            'glow-multi': {
              '0%': { boxShadow: '0 0 10px rgba(125, 211, 252, 0.5), 0 0 20px rgba(192, 132, 252, 0.3)' },
              '50%': { boxShadow: '0 0 15px rgba(147, 197, 253, 0.7), 0 0 30px rgba(125, 211, 252, 0.4)' },
              '100%': { boxShadow: '0 0 20px rgba(192, 132, 252, 0.6), 0 0 40px rgba(147, 197, 253, 0.5)' },
            }
          }
        }
      }
    }
  </script>
  
  <!-- 自定义工具类 -->
  <style type="text/tailwindcss">
    @layer utilities {
      .glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .glass-dark {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.08);
      }
      .glass-lighter {
        background: rgba(255, 255, 255, 0.35);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.25);
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .text-shadow-glow {
        text-shadow: 0 0 10px rgba(125, 211, 252, 0.5), 0 0 20px rgba(192, 132, 252, 0.3);
      }
      .content-auto {
        content-visibility: auto;
      }
      .modal-backdrop {
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
      }
    }
  </style>
  
  <style>
    /* 基础样式 */
    body {
      background-color: #f8fafc;
      background-image: 
        radial-gradient(circle at 20% 30%, rgba(125, 211, 252, 0.15) 0%, transparent 25%),
        radial-gradient(circle at 80% 70%, rgba(192, 132, 252, 0.1) 0%, transparent 30%),
        radial-gradient(circle at 40% 80%, rgba(147, 197, 253, 0.12) 0%, transparent 20%);
      background-attachment: fixed;
    }
    
    /* 音频可视化 */
    .visualizer {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 40px;
    }
    
    .visualizer-bar {
      width: 3px;
      border-radius: 3px;
      transition: height 0.2s ease;
    }
    
    /* 歌词滚动 */
    .lyrics-container {
      height: 120px;
      overflow: hidden;
      position: relative;
    }
    
    .lyrics {
      position: absolute;
      width: 100%;
      transition: transform 0.5s ease;
    }
    
    .lyric-line {
      transition: opacity 0.5s ease, transform 0.5s ease, text-shadow 0.5s ease;
      opacity: 0.6;
      transform: scale(0.95);
    }
    
    .lyric-line.active {
      opacity: 1;
      transform: scale(1);
      font-weight: 500;
      text-shadow: 0 0 8px rgba(125, 211, 252, 0.3);
    }
    
    /* 上传区域动画 */
    .upload-area {
      transition: all 0.3s ease;
    }
    
    .upload-area.dragover {
      transform: scale(1.02);
      background: linear-gradient(135deg, rgba(125, 211, 252, 0.3), rgba(192, 132, 252, 0.2));
    }
    
    /* 装饰元素 */
    .decor-element {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.15;
      z-index: -1;
    }
    
    /* 密码模态框动画 */
    .modal-enter {
      opacity: 0;
      transform: scale(0.9);
    }
    .modal-enter-active {
      opacity: 1;
      transform: scale(1);
      transition: opacity 300ms, transform 300ms;
    }
    .modal-exit {
      opacity: 1;
    }
    .modal-exit-active {
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 300ms, transform 300ms;
    }
  </style>
</head>

<body class="min-h-screen font-sans text-gray-800 flex flex-col">
  <!-- 背景装饰元素 -->
  <div class="decor-element bg-glow w-96 h-96 top-20 left-10 animate-pulse-slow"></div>
  <div class="decor-element bg-glow2 w-80 h-80 bottom-20 right-10 animate-pulse-slow" style="animation-delay: 1s"></div>
  <div class="decor-element bg-glow3 w-64 h-64 top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 animate-pulse-slow" style="animation-delay: 2s"></div>
  
  <!-- 粒子背景 -->
  <div id="particles-js" class="fixed inset-0 z-0 opacity-30 pointer-events-none"></div>
  
  <!-- 管理员密码验证模态框 -->
  <div id="passwordModal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="absolute inset-0 bg-black/30 modal-backdrop" id="modalBackdrop"></div>
    <div class="glass rounded-2xl p-8 max-w-md w-full mx-4 relative z-10 shadow-2xl animate-float">
      <h3 class="text-xl font-semibold mb-6 text-center bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">管理员验证</h3>
      
      <div class="mb-4">
        <label for="adminPassword" class="block text-sm font-medium text-gray-700 mb-1">请输入管理员密码</label>
        <div class="relative">
          <input type="password" id="adminPassword" class="w-full glass-dark px-4 py-3 rounded-lg focus:outline-none focus:ring-2 focus:ring-glow transition-all duration-300" placeholder="输入密码">
          <button id="togglePassword" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-glow transition-colors">
            <i class="fa fa-eye-slash"></i>
          </button>
        </div>
      </div>
      
      <div class="text-red-500 text-sm mb-4 hidden" id="passwordError">密码错误，请重新输入</div>
      
      <div class="flex gap-3">
        <button id="cancelAuth" class="flex-1 glass-dark px-4 py-2 rounded-lg hover:bg-opacity-80 transition-all duration-300">取消</button>
        <button id="confirmAuth" class="flex-1 bg-gradient-to-r from-glow to-glow2 text-white px-4 py-2 rounded-lg hover:opacity-90 transition-all duration-300">确认</button>
      </div>
    </div>
  </div>
  
  <!-- 导航栏 -->
  <header class="glass sticky top-0 z-50 px-6 py-4 shadow-sm transition-all duration-500 hover:glass-lighter">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center gap-2">
        <div class="w-10 h-10 rounded-full bg-gradient-to-r from-glow via-glow3 to-glow2 flex items-center justify-center animate-pulse-slow">
          <i class="fa fa-music text-white"></i>
        </div>
        <h1 class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-gray-800 via-gray-700 to-gray-600">清澈电台</h1>
      </div>
      
      <nav class="hidden md:flex items-center gap-6">
        <a href="#" class="hover:text-glow transition-colors duration-300 relative group">
          首页
          <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-glow to-glow2 transition-all duration-300 group-hover:w-full"></span>
        </a>
        <a href="#" class="hover:text-glow transition-colors duration-300 relative group">
          关于
          <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-glow to-glow2 transition-all duration-300 group-hover:w-full"></span>
        </a>
        <a href="#" class="hover:text-glow transition-colors duration-300 relative group">
          帮助
          <span class="absolute -bottom-1 left-0 w-0 h-0.5 bg-gradient-to-r from-glow to-glow2 transition-all duration-300 group-hover:w-full"></span>
        </a>
      </nav>
      
      <button id="uploadToggle" class="glass-dark px-4 py-2 rounded-full text-sm font-medium hover:bg-opacity-80 transition-all duration-300 flex items-center gap-2 hover:shadow-lg hover:shadow-glow/10">
        <i class="fa fa-upload"></i>
        <span>上传音乐</span>
      </button>
      
      <button class="md:hidden text-xl glass-dark p-2 rounded-full hover:bg-opacity-80 transition-all duration-300">
        <i class="fa fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="flex-grow container mx-auto px-6 py-12 z-10 relative">
    <!-- 上传区域 (默认隐藏) -->
    <div id="uploadArea" class="glass rounded-2xl p-6 mb-10 hidden animate-float">
      <h2 class="text-xl font-semibold mb-4 text-center bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">上传音乐和歌词</h2>
      <p class="text-center text-gray-600 mb-6 text-sm">上传的内容仅用于播放，不会在前端显示</p>
      
      <div class="upload-area glass-dark rounded-xl p-8 text-center mb-6" id="fileDropArea">
        <i class="fa fa-cloud-upload text-4xl bg-clip-text text-transparent bg-gradient-to-r from-glow to-glow2 mb-3"></i>
        <p class="mb-2">拖放文件到此处，或点击选择文件</p>
        <p class="text-xs text-gray-500">支持 MP3 音频文件和 LRC 歌词文件</p>
        <input type="file" id="fileInput" class="hidden" accept=".mp3,.lrc" multiple>
        <button id="browseFiles" class="mt-4 glass px-4 py-2 rounded-full text-sm font-medium hover:bg-opacity-80 transition-all duration-300 hover:shadow-lg hover:shadow-glow/20">
          选择文件
        </button>
      </div>
      
      <div id="uploadProgress" class="hidden">
        <div class="w-full bg-gray-200/50 rounded-full h-2 mb-2 glass-dark">
          <div id="progressBar" class="bg-gradient-to-r from-glow via-glow3 to-glow2 h-2 rounded-full" style="width: 0%"></div>
        </div>
        <p class="text-sm text-center text-gray-600" id="progressText">准备上传...</p>
      </div>
    </div>
    
    <!-- 播放区域 -->
    <div class="max-w-2xl mx-auto">
      <!-- 专辑封面 -->
      <div class="relative mb-10">
        <div class="w-64 h-64 md:w-80 md:h-80 mx-auto rounded-full overflow-hidden glass animate-float shadow-lg animate-glow-multi">
          <img src="https://picsum.photos/seed/radio/400/400" alt="专辑封面" class="w-full h-full object-cover">
        </div>
        <!-- 装饰光环 -->
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[110%] h-[110%] rounded-full border-2 border-glow/30 animate-pulse-slow"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[120%] h-[120%] rounded-full border border-glow2/20 animate-pulse-slow" style="animation-delay: 1s"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[130%] h-[130%] rounded-full border border-glow3/15 animate-pulse-slow" style="animation-delay: 2s"></div>
      </div>
      
      <!-- 播放控制 -->
      <div class="glass rounded-2xl p-6 md:p-8 shadow-lg relative overflow-hidden group hover:shadow-xl hover:shadow-glow/10 transition-all duration-500">
        <!-- 内部光效装饰 -->
        <div class="absolute top-0 left-1/4 w-64 h-64 bg-glow/5 rounded-full filter blur-3xl -translate-y-1/2 group-hover:bg-glow/10 transition-all duration-1000"></div>
        <div class="absolute bottom-0 right-1/4 w-64 h-64 bg-glow2/5 rounded-full filter blur-3xl translate-y-1/2 group-hover:bg-glow2/10 transition-all duration-1000"></div>
        
        <!-- 歌曲信息 (仅显示"正在播放"，不显示实际文件名) -->
        <div class="text-center mb-6 relative">
          <h2 class="text-xl md:text-2xl font-semibold text-shadow text-shadow-glow">正在播放</h2>
          <p class="text-gray-600 text-sm mt-1">清澈的声音 · 治愈的旋律</p>
        </div>
        
        <!-- 音频可视化 -->
        <div class="visualizer mb-6 relative">
          <!-- 动态生成的频谱柱形 -->
        </div>
        
        <!-- 进度条 -->
        <div class="mb-6 relative">
          <div class="flex justify-between text-xs text-gray-500 mb-1">
            <span id="currentTime">00:00</span>
            <span id="totalTime">00:00</span>
          </div>
          <div class="w-full bg-gray-200/50 rounded-full h-1.5 cursor-pointer glass-dark" id="progressContainer">
            <div id="progress" class="bg-gradient-to-r from-glow via-glow3 to-glow2 h-1.5 rounded-full" style="width: 0%"></div>
            <div id="progressHandle" class="w-3 h-3 bg-white rounded-full shadow-md absolute -mt-0.75 cursor-pointer hover:scale-125 transition-transform duration-300" style="left: 0%"></div>
          </div>
        </div>
        
        <!-- 控制按钮 -->
        <div class="flex justify-center items-center gap-4 md:gap-8 mb-8 relative">
          <button class="w-10 h-10 rounded-full glass-dark flex items-center justify-center hover:bg-opacity-80 transition-all duration-300 hover:shadow-lg hover:shadow-glow/10 hover:scale-110">
            <i class="fa fa-step-backward"></i>
          </button>
          <button class="w-12 h-12 rounded-full glass-dark flex items-center justify-center hover:bg-opacity-80 transition-all duration-300 hover:shadow-lg hover:shadow-glow/10 hover:scale-110">
            <i class="fa fa-backward"></i>
          </button>
          <button id="playPauseBtn" class="w-16 h-16 md:w-20 md:h-20 rounded-full bg-gradient-to-r from-glow via-glow3 to-glow2 flex items-center justify-center text-white hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl hover:shadow-glow/20">
            <i class="fa fa-play text-xl md:text-2xl"></i>
          </button>
          <button class="w-12 h-12 rounded-full glass-dark flex items-center justify-center hover:bg-opacity-80 transition-all duration-300 hover:shadow-lg hover:shadow-glow/10 hover:scale-110">
            <i class="fa fa-forward"></i>
          </button>
          <button class="w-10 h-10 rounded-full glass-dark flex items-center justify-center hover:bg-opacity-80 transition-all duration-300 hover:shadow-lg hover:shadow-glow/10 hover:scale-110">
            <i class="fa fa-step-forward"></i>
          </button>
        </div>
        
        <!-- 音量控制 -->
        <div class="flex items-center justify-center gap-3 mb-6 relative">
          <i class="fa fa-volume-up text-gray-600 transition-colors duration-300 hover:text-glow"></i>
          <div class="w-24 md:w-40 bg-gray-200/50 rounded-full h-1.5 cursor-pointer glass-dark" id="volumeContainer">
            <div id="volumeLevel" class="bg-gradient-to-r from-glow via-glow3 to-glow2 h-1.5 rounded-full" style="width: 80%"></div>
            <div id="volumeHandle" class="w-3 h-3 bg-white rounded-full shadow-md absolute -mt-0.75 cursor-pointer hover:scale-125 transition-transform duration-300" style="left: 80%"></div>
          </div>
        </div>
        
        <!-- 歌词显示 -->
        <div class="glass-dark rounded-xl p-4 mt-8 relative hover:shadow-lg hover:shadow-glow/5 transition-all duration-500">
          <h3 class="text-center text-sm font-medium mb-3 bg-clip-text text-transparent bg-gradient-to-r from-gray-800 to-gray-600">歌词</h3>
          <div class="lyrics-container">
            <div class="lyrics text-center">
              <p class="lyric-line mb-2">准备播放音乐...</p>
              <p class="lyric-line mb-2">上传歌曲后将显示歌词</p>
              <p class="lyric-line mb-2">享受清澈的声音</p>
              <p class="lyric-line mb-2">让旋律治愈心灵</p>
              <p class="lyric-line mb-2">在这梦幻的空间</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- 页脚 -->
  <footer class="glass mt-16 py-6 z-10 relative hover:glass-lighter transition-all duration-500">
    <div class="container mx-auto px-6 text-center text-gray-600 text-sm">
      <p>清澈电台 &copy; 2023 | 用声音治愈心灵</p>
      <div class="flex justify-center gap-4 mt-3">
        <a href="#" class="hover:text-glow transition-colors duration-300 hover:scale-110 inline-block"><i class="fa fa-github"></i></a>
        <a href="#" class="hover:text-glow2 transition-colors duration-300 hover:scale-110 inline-block"><i class="fa fa-twitter"></i></a>
        <a href="#" class="hover:text-glow3 transition-colors duration-300 hover:scale-110 inline-block"><i class="fa fa-envelope"></i></a>
      </div>
    </div>
  </footer>

  <!-- 音频元素 (隐藏) -->
  <audio id="audioPlayer" loop>
    <source src="" type="audio/mpeg">
  </audio>

  <!-- 粒子效果库 -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  
  <script>
    // 初始化粒子背景
    particlesJS("particles-js", {
      particles: {
        number: { value: 80, density: { enable: true, value_area: 800 } },
        color: { 
          value: ["#7dd3fc", "#c084fc", "#93c5fd"]
        },
        shape: { type: "circle" },
        opacity: { 
          value: 0.3, 
          random: true, 
          anim: { enable: true, speed: 1, opacity_min: 0.1, sync: false } 
        },
        size: { 
          value: 3, 
          random: true, 
          anim: { enable: true, speed: 2, size_min: 0.5, sync: false } 
        },
        line_linked: {
          enable: true,
          distance: 150,
          color: "#bae6fd",
          opacity: 0.2,
          width: 1
        },
        move: {
          enable: true,
          speed: 1,
          direction: "none",
          random: true,
          straight: false,
          out_mode: "out",
          bounce: false
        }
      },
      interactivity: {
        detect_on: "canvas",
        events: {
          onhover: { enable: true, mode: "grab" },
          onclick: { enable: true, mode: "push" },
          resize: true
        },
        modes: {
          grab: { distance: 140, line_linked: { opacity: 0.4 } },
          push: { particles_nb: 3 }
        }
      },
      retina_detect: true
    });
    
    // 全局状态管理
    const appState = {
      isAuthenticated: false,
      // 从环境变量获取API基础URL（实际部署时由Cloudflare Pages设置）
      apiBaseUrl: window.API_BASE_URL || 'https://your-custom-domain.workers.dev/api'
    };
    
    // DOM元素
    const passwordModal = document.getElementById('passwordModal');
    const adminPassword = document.getElementById('adminPassword');
    const togglePassword = document.getElementById('togglePassword');
    const passwordError = document.getElementById('passwordError');
    const confirmAuth = document.getElementById('confirmAuth');
    const cancelAuth = document.getElementById('cancelAuth');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const uploadToggle = document.getElementById('uploadToggle');
    const uploadArea = document.getElementById('uploadArea');
    
    // 创建音频可视化频谱
    function createVisualizerBars() {
      const visualizer = document.querySelector('.visualizer');
      visualizer.innerHTML = '';
      
      for (let i = 0; i < 24; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        const gradientIndex = Math.floor(Math.random() * 3);
        if (gradientIndex === 0) {
          bar.style.background = 'linear-gradient(to top, #7dd3fc, #bae6fd)';
        } else if (gradientIndex === 1) {
          bar.style.background = 'linear-gradient(to top, #c084fc, #e9d5ff)';
        } else {
          bar.style.background = 'linear-gradient(to top, #93c5fd, #dbeafe)';
        }
        bar.style.height = `${Math.random() * 30 + 5}px`;
        visualizer.appendChild(bar);
      }
    }
    
    // 更新频谱动画
    function updateVisualizer() {
      const bars = document.querySelectorAll('.visualizer-bar');
      bars.forEach(bar => {
        const maxHeight = audioPlayer.paused ? 30 : 40;
        const height = Math.random() * maxHeight + 5;
        bar.style.height = `${height}px`;
      });
      
      if (audioPlayer.paused) {
        setTimeout(updateVisualizer, 300);
      } else {
        requestAnimationFrame(updateVisualizer);
      }
    }
    
    // 格式化时间
    function formatTime(seconds) {
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    // 解析LRC歌词
    function parseLyrics(lrcText) {
      const lines = lrcText.split('\n');
      const lyrics = [];
      
      const timeRegex = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
      
      lines.forEach(line => {
        const match = timeRegex.exec(line);
        if (match) {
          const minutes = parseInt(match[1]);
          const seconds = parseInt(match[2]);
          const milliseconds = parseInt(match[3]);
          
          const time = minutes * 60 + seconds + milliseconds / 1000;
          const text = line.replace(timeRegex, '').trim();
          
          if (text) {
            lyrics.push({ time, text });
          }
        }
      });
      
      return lyrics.sort((a, b) => a.time - b.time);
    }
    
    // 更新歌词显示
    function updateLyrics(currentTime) {
      const lyricsContainer = document.querySelector('.lyrics');
      const lines = document.querySelectorAll('.lyric-line');
      
      if (lines.length >= 3) {
        const lineIndex = Math.floor(currentTime / 5) % lines.length;
        
        lines.forEach((line, index) => {
          line.classList.remove('active');
          if (index === lineIndex) {
            line.classList.add('active');
            const containerHeight = document.querySelector('.lyrics-container').clientHeight;
            const lineHeight = line.clientHeight;
            const scrollPosition = (index * lineHeight) - (containerHeight / 2) + (lineHeight / 2);
            lyricsContainer.style.transform = `translateY(-${scrollPosition}px)`;
          }
        });
      }
    }
    
    // 管理员身份验证相关函数
    function showPasswordModal() {
      passwordModal.classList.remove('hidden');
      adminPassword.focus();
      // 重置密码输入和错误状态
      adminPassword.value = '';
      passwordError.classList.add('hidden');
    }
    
    function hidePasswordModal() {
      passwordModal.classList.add('hidden');
    }
    
    async function authenticateAdmin(password) {
      try {
        // 调用Cloudflare Workers验证密码
        const response = await fetch(`${appState.apiBaseUrl}/auth`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ password })
        });
        
        const data = await response.json();
        
        if (response.ok && data.authenticated) {
          // 存储认证状态（会话级别）
          appState.isAuthenticated = true;
          // 存储JWT令牌（实际应用中使用）
          if (data.token) {
            localStorage.setItem('adminToken', data.token);
          }
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Authentication error:', error);
        return false;
      }
    }
    
    // 处理上传文件到后端
    async function uploadFilesToBackend(files, token) {
      const formData = new FormData();
      
      // 添加所有文件到表单数据
      files.forEach(file => {
        formData.append('files', file);
      });
      
      try {
        // 显示上传进度
        uploadProgress.classList.remove('hidden');
        progressBar.style.width = '0%';
        progressText.textContent = '正在上传...';
        
        // 调用Cloudflare Workers上传接口
        const response = await fetch(`${appState.apiBaseUrl}/upload`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('上传失败');
        }
        
        const result = await response.json();
        return result;
      } catch (error) {
        console.error('Upload error:', error);
        progressText.textContent = `上传失败: ${error.message}`;
        return null;
      }
    }
    
    // 初始化音频播放器
    const audioPlayer = document.getElementById('audioPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const progress = document.getElementById('progress');
    const progressHandle = document.getElementById('progressHandle');
    const currentTimeEl = document.getElementById('currentTime');
    const totalTimeEl = document.getElementById('totalTime');
    const volumeLevel = document.getElementById('volumeLevel');
    const volumeHandle = document.getElementById('volumeHandle');
    const progressContainer = document.getElementById('progressContainer');
    const volumeContainer = document.getElementById('volumeContainer');
    
    // 上传区域控制
    const fileDropArea = document.getElementById('fileDropArea');
    const fileInput = document.getElementById('fileInput');
    const browseFiles = document.getElementById('browseFiles');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    
    // 模拟从服务器加载歌曲列表
    const mockSongs = [
      { id: 1, url: 'https://samplelib.com/lib/preview/mp3/sample-15s.mp3', title: '示例音乐 1' },
      { id: 2, url: 'https://samplelib.com/lib/preview/mp3/sample-6s.mp3', title: '示例音乐 2' }
    ];
    
    // 当前播放的歌曲索引
    let currentSongIndex = 0;
    
    // 初始化播放器
    function initPlayer() {
      // 检查本地存储中的认证状态
      const savedToken = localStorage.getItem('adminToken');
      if (savedToken) {
        appState.isAuthenticated = true;
      }
      
      // 加载第一首歌
      loadSong(currentSongIndex);
      
      // 创建频谱柱形
      createVisualizerBars();
      updateVisualizer();
      
      // 播放/暂停按钮事件
      playPauseBtn.addEventListener('click', togglePlayPause);
      
      // 音频时间更新事件
      audioPlayer.addEventListener('timeupdate', updateProgress);
      
      // 音频加载完成事件
      audioPlayer.addEventListener('loadedmetadata', () => {
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      });
      
      // 音频结束事件
      audioPlayer.addEventListener('ended', playNextSong);
      
      // 进度条点击事件
      progressContainer.addEventListener('click', seek);
      
      // 音量控制事件
      volumeContainer.addEventListener('click', setVolume);
      
      // 上传区域切换 - 需要管理员验证
      uploadToggle.addEventListener('click', async () => {
        if (!appState.isAuthenticated) {
          // 未认证，显示密码模态框
          showPasswordModal();
        } else {
          // 已认证，直接切换上传区域显示状态
          uploadArea.classList.toggle('hidden');
        }
      });
      
      // 密码模态框事件
      confirmAuth.addEventListener('click', async () => {
        const password = adminPassword.value.trim();
        if (!password) {
          passwordError.textContent = '请输入密码';
          passwordError.classList.remove('hidden');
          return;
        }
        
        const isAuthenticated = await authenticateAdmin(password);
        if (isAuthenticated) {
          hidePasswordModal();
          uploadArea.classList.remove('hidden');
        } else {
          passwordError.textContent = '密码错误，请重新输入';
          passwordError.classList.remove('hidden');
        }
      });
      
      cancelAuth.addEventListener('click', hidePasswordModal);
      modalBackdrop.addEventListener('click', hidePasswordModal);
      
      // 密码显示/隐藏切换
      togglePassword.addEventListener('click', () => {
        const type = adminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
        adminPassword.setAttribute('type', type);
        togglePassword.innerHTML = type === 'password' ? 
          '<i class="fa fa-eye-slash"></i>' : 
          '<i class="fa fa-eye"></i>';
      });
      
      // 文件上传事件
      setupFileUpload();
    }
    
    // 加载歌曲
    function loadSong(index) {
      if (mockSongs[index]) {
        audioPlayer.src = mockSongs[index].url;
        audioPlayer.load();
      }
    }
    
    // 切换播放/暂停
    function togglePlayPause() {
      if (audioPlayer.paused) {
        audioPlayer.play();
        playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl md:text-2xl"></i>';
      } else {
        audioPlayer.pause();
        playPauseBtn.innerHTML = '<i class="fa fa-play text-xl md:text-2xl"></i>';
      }
    }
    
    // 更新进度条
    function updateProgress() {
      const percent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      progress.style.width = `${percent}%`;
      progressHandle.style.left = `${percent}%`;
      currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      
      // 更新歌词
      updateLyrics(audioPlayer.currentTime);
    }
    
    // 进度条跳转
    function seek(e) {
      const rect = progressContainer.getBoundingClientRect();
      const pos = (e.clientX - rect.left) / rect.width;
      audioPlayer.currentTime = pos * audioPlayer.duration;
    }
    
    // 设置音量
    function setVolume(e) {
      const rect = volumeContainer.getBoundingClientRect();
      const volume = (e.clientX - rect.left) / rect.width;
      audioPlayer.volume = volume;
      volumeLevel.style.width = `${volume * 100}%`;
      volumeHandle.style.left = `${volume * 100}%`;
    }
    
    // 播放下一首歌
    function playNextSong() {
      currentSongIndex = (currentSongIndex + 1) % mockSongs.length;
      loadSong(currentSongIndex);
      audioPlayer.play();
      playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl md:text-2xl"></i>';
    }
    
    // 播放上一首歌
    function playPrevSong() {
      currentSongIndex = (currentSongIndex - 1 + mockSongs.length) % mockSongs.length;
      loadSong(currentSongIndex);
      audioPlayer.play();
      playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl md:text-2xl"></i>';
    }
    
    // 设置文件上传
    function setupFileUpload() {
      // 浏览文件按钮
      browseFiles.addEventListener('click', () => {
        fileInput.click();
      });
      
      // 文件选择事件
      fileInput.addEventListener('change', handleFiles);
      
      // 拖放事件
      fileDropArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileDropArea.classList.add('dragover');
      });
      
      fileDropArea.addEventListener('dragleave', () => {
        fileDropArea.classList.remove('dragover');
      });
      
      fileDropArea.addEventListener('drop', (e) => {
        e.preventDefault();
        fileDropArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
          handleFiles(e.dataTransfer.files);
        }
      });
    }
    
    // 处理上传的文件
    async function handleFiles(files) {
      // 转换为数组以便处理
      const fileList = files instanceof FileList ? Array.from(files) : files;
      
      // 过滤出音频和歌词文件
      const audioFiles = fileList.filter(file => file.type === 'audio/mpeg');
      const lyricFiles = fileList.filter(file => file.name.endsWith('.lrc'));
      
      if (audioFiles.length === 0) {
        alert('请上传MP3格式的音频文件');
        return;
      }
      
      // 获取认证令牌
      const token = localStorage.getItem('adminToken');
      if (!token) {
        alert('认证已过期，请重新验证');
        showPasswordModal();
        return;
      }
      
      // 上传文件到后端
      const result = await uploadFilesToBackend(fileList, token);
      
      if (result && result.success) {
        // 上传成功，更新进度显示
        progressBar.style.width = '100%';
        progressText.textContent = '上传完成，准备播放...';
        
        // 从后端获取新上传的歌曲URL
        setTimeout(() => {
          // 实际应用中应该使用后端返回的音频URL
          const audioUrl = result.audioUrl || URL.createObjectURL(audioFiles[0]);
          mockSongs.unshift({ 
            id: Date.now(), 
            url: audioUrl, 
            title: '刚刚上传的歌曲' 
          });
          currentSongIndex = 0;
          loadSong(currentSongIndex);
          audioPlayer.play();
          playPauseBtn.innerHTML = '<i class="fa fa-pause text-xl md:text-2xl"></i>';
          
          uploadProgress.classList.add('hidden');
          uploadArea.classList.add('hidden');
        }, 1000);
      } else {
        // 上传失败
        progressText.textContent = '上传失败，请重试';
      }
    }
    
    // 初始化
    document.addEventListener('DOMContentLoaded', initPlayer);
  </script>
</body>
</html>
